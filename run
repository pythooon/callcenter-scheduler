#!/bin/bash

if [[ $EUID -ne 0 ]]; then
    echo "Ten skrypt musi byÄ‡ uruchomiony jako root. UÅ¼yj sudo."
    exit 1
fi

copy_env_files() {
    echo "ğŸ“ Sprawdzanie i kopiowanie plikÃ³w .env..."

    for dir in "." "./backend" "./frontend"; do
        env_file="$dir/.env"
        example_file="$dir/.env.example"

        if [[ -f "$env_file" ]]; then
            echo "âœ… Plik $env_file juÅ¼ istnieje â€“ pomijam kopiowanie."
        elif [[ -f "$example_file" ]]; then
            cp "$example_file" "$env_file"
            echo "ğŸ“„ Skopiowano $example_file do $env_file"
        else
            echo "âš ï¸ Brak pliku $example_file â€“ pomijam kopiowanie."
        fi
    done
}

get_app_env() {
    if [[ -f .env ]]; then
        export $(grep -v '^#' .env | xargs)
        echo $APP_ENV
    else
        echo "âŒ BÅ‚Ä…d: plik .env nie zostaÅ‚ znaleziony!"
        exit 1
    fi
}

copy_nginx_config_files() {
    env=$(get_app_env)
    echo "âš™ï¸  Kopiowanie konfiguracji Nginx na podstawie APP_ENV=$env..."

    cp "./backend/nginx/api.conf.$env.example" "./backend/nginx/api.conf"
    cp "./backend/nginx/frontend.conf.$env.example" "./backend/nginx/frontend.conf"

    echo "âœ… Skonfigurowano pliki Nginx."
}

show_menu() {
    clear
    echo "---------------------------------------------"
    echo " ğŸ³ Menu zarzÄ…dzania kontenerami Docker Compose"
    echo "---------------------------------------------"
    echo "1) Zbuduj wszystkie serwisy"
    echo "2) Restartuj wszystkie serwisy"
    echo "3) WymuÅ› przebudowÄ™ i restart"
    echo "4) Zbuduj i restartuj konkretny serwis"
    echo "5) Zbuduj wszystkie i restartuj"
    echo "6) Uruchom wszystkie serwisy"
    echo "7) PodglÄ…d logÃ³w wszystkich serwisÃ³w"
    echo "8) PodglÄ…d logÃ³w konkretnego serwisu"
    echo "9) SprawdÅº status serwisÃ³w"
    echo "10) Zatrzymaj i usuÅ„ wszystkie serwisy"
    echo "11) WyjÅ›cie"
    echo "---------------------------------------------"
}

build_services() {
    echo "ğŸ”¨ Budowanie wszystkich serwisÃ³w..."
    docker compose build
}

restart_services() {
    echo "ğŸ” Restartowanie wszystkich serwisÃ³w..."
    docker compose restart
}

force_recreate_services() {
    echo "â™»ï¸  Wymuszanie przebudowy i restartu wszystkich serwisÃ³w..."
    docker compose up --force-recreate -d
}

build_and_restart_service() {
    echo "ğŸ”§ Podaj nazwÄ™ serwisu do zbudowania i restartu:"
    read service
    docker compose up --build --no-deps -d "$service"
}

build_all_and_restart() {
    echo "ğŸ—ï¸  Budowanie i uruchamianie wszystkich serwisÃ³w..."
    docker compose up --build -d
}

start_services() {
    echo "ğŸš€ Uruchamianie wszystkich serwisÃ³w..."
    docker compose up -d
}

view_logs() {
    echo "ğŸ“‹ WyÅ›wietlanie logÃ³w wszystkich serwisÃ³w..."
    docker compose logs -f
}

view_logs_for_service() {
    echo "ğŸ“‹ Podaj nazwÄ™ serwisu do podglÄ…du logÃ³w:"
    read service
    if [[ -z "$service" ]]; then
        echo "â— BÅ‚Ä…d: nie podano nazwy serwisu."
        return
    fi
    docker compose logs -f "$service"
}

check_docker_status() {
    echo "ğŸ“¦ Sprawdzanie statusu serwisÃ³w..."
    docker compose ps
}

shutdown_and_remove_all_services() {
    echo "ğŸ›‘ Zatrzymywanie i usuwanie wszystkich serwisÃ³w..."
    docker compose down --volumes --remove-orphans
    echo "ğŸ§¹ Wszystkie serwisy zostaÅ‚y zatrzymane i usuniÄ™te."
}

set_permissions() {
    echo "ğŸ” Ustawianie uprawnieÅ„..."
    chmod +x run.sh
    chmod -R 755 ./backend/db_data
    echo "âœ… Uprawnienia ustawione pomyÅ›lnie."
}

while true; do
    copy_env_files
    copy_nginx_config_files

    show_menu
    echo -n "ğŸ”½ Wybierz opcjÄ™: "
    read option

    case $option in
        1) build_services ;;
        2) restart_services ;;
        3) force_recreate_services ;;
        4) build_and_restart_service ;;
        5) build_all_and_restart ;;
        6) start_services ;;
        7) view_logs ;;
        8) view_logs_for_service ;;
        9) check_docker_status ;;
        10) shutdown_and_remove_all_services ;;
        11)
            echo "ğŸ‘‹ Zamykanie skryptu..."
            exit 0
            ;;
        *) echo "âŒ NieprawidÅ‚owa opcja. SprÃ³buj ponownie." ;;
    esac

    echo "ğŸ” NaciÅ›nij dowolny klawisz, aby kontynuowaÄ‡..."
    read -n 1 -s
done
